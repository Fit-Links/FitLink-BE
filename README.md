# ğŸ‹ï¸â€â™‚ï¸ í”¼íŠ¸ë‹ˆìŠ¤ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ (Fit-link)

**íŠ¸ë ˆì´ë„ˆì™€ íšŒì›ì˜ ë°˜ë³µì ì´ê³  ë³µì¡í•œ ì˜ˆì•½ ê³¼ì •ì„ ìë™í™”í•˜ê³ , íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ ì˜ˆì•½ í”Œë«í¼**

<br />

---

## ğŸ“– ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ê°œìš”](#1-í”„ë¡œì íŠ¸-ê°œìš”)
2. [í”„ë¡œì íŠ¸ ë™ê¸°](#2-í”„ë¡œì íŠ¸-ë™ê¸°)
3. [ê¸°ìˆ  ìŠ¤íƒ](#3-ê¸°ìˆ -ìŠ¤íƒ)
4. [ì•„í‚¤í…ì²˜](#4-ì•„í‚¤í…ì²˜)
5. [ì£¼ìš” ê¸°ëŠ¥](#5-ì£¼ìš”-ê¸°ëŠ¥)
6. [ê¸°ëŠ¥ ëª…ì„¸ ë° ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨](#6-ê¸°ëŠ¥-ëª…ì„¸-ë°-ì‹œí€€ìŠ¤-ë‹¤ì´ì–´ê·¸ë¨)
7. [API ëª…ì„¸](#7-api-ëª…ì„¸ì„œ)
8. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#8-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)
9. [ê°œë°œ ì¤‘ ê³ ë¯¼ê³¼ í•´ê²°](#9-ê°œë°œ-ì¤‘-ê³ ë¯¼ê³¼-í•´ê²°)
10. [ë°°í¬ ë§í¬ ë° ìŠ¤í¬ë¦°ìƒ·](#10-ë°°í¬-ë§í¬-ë°-ìŠ¤í¬ë¦°ìƒ·)
11. [í–¥í›„ ê³„íš](#11-í–¥í›„-ê³„íš)
12. [íŒ€ì› ì •ë³´](#12-íŒ€ì›-ì •ë³´)

---
## 1. í”„ë¡œì íŠ¸ ê°œìš”
<br />

- **í”„ë¡œì íŠ¸ëª…**: í”¼íŠ¸ë‹ˆìŠ¤ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ
- **ê¸°ê°„**: 2024.12 ~ 
- **ëª©ì **: í—¬ìŠ¤ì¥ ë‚´ë¶€ì˜ PT ì˜ˆì•½ ë° íŠ¸ë ˆì´ë„ˆ ê´€ë¦¬ ì—…ë¬´ë¥¼ ë””ì§€í„¸í™”
- **ëŒ€ìƒ ì‚¬ìš©ì**: íŠ¸ë ˆì´ë„ˆ, íšŒì›

<br />

---
## 2. í”„ë¡œì íŠ¸ ë™ê¸°
<br />

ë³´í†µ PT íšŒì›ë“¤ì€ ë§¤ë²ˆ PT ìˆ˜ì—…ì´ ëë‚œ ë’¤ êµ¬ë‘ë¡œ ë‹¤ìŒ ìˆ˜ì—…ì„ ì¡ìŠµë‹ˆë‹¤. ì´ë•Œ íšŒì› ì…ì¥ì—ì„œëŠ”
<span style="color:#cd8741"> **ì–´ëŠ ë‚ ì§œ, ì–´ëŠ ì‹œê°„ì— ìˆ˜ì—…ì´ ë¹„ì–´ ìˆëŠ”ì§€ ì•Œ ìˆ˜ ì—†ì–´ ë§¤ìš° ë¶ˆí¸** </span>í•©ë‹ˆë‹¤.
íŠ¸ë ˆì´ë„ˆ ì…ì¥ì—ì„œë„ íšŒì›ê³¼ ìˆ˜ì—… ë‚ ì§œë¥¼ ì¡ê¸° ìœ„í•´
<span style="color:#cd8741">**ë§¤ë²ˆ ìˆ˜ì—… ì‹œê°„í‘œë¥¼ í™•ì¸í•´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€**</span> ì´ ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ íŠ¸ë ˆì´ë„ˆì™€ íšŒì› ê°„ì˜ ë²ˆê±°ë¡œìš´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì˜ˆì•½ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ë ¤ê³  í•©ë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ íšŒì›ì€ ì–¸ì œ ì–´ë””ì„œë“  <span style="color:#cd8741">  **ì‹¤ì‹œê°„ìœ¼ë¡œ** </span> ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ëŒ€ë¥¼ í™•ì¸í•˜ì—¬ ì˜ˆì•½í•  ìˆ˜ ìˆê³ ,
íŠ¸ë ˆì´ë„ˆ ì—­ì‹œ ìˆ˜ì—… ì¼ì • ê´€ë¦¬ì˜ ë¶€ë‹´ì„ ì¤„ì¼ ìˆ˜ ìˆë„ë¡ ìë™í™”ëœ ì‹œìŠ¤í…œì„ ì œê³µí•©ë‹ˆë‹¤.

<br />

> ìš°ë¦¬ê°€ ë§Œë“¤ ì„œë¹„ìŠ¤ëŠ” ë„¤ì´ë²„ ì˜ˆì•½ì²˜ëŸ¼ ëˆ„êµ¬ë‚˜ ì˜ˆì•½í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì´ ì•„ë‹ˆê³ ,
> <span style="color:#cd8741"> **íŠ¸ë ˆì´ë„ˆì™€ PTë¥¼ ë°›ëŠ” íšŒì›ë§Œ ì˜ˆì•½í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.** </span>

<br />

---
## 3. ê¸°ìˆ  ìŠ¤íƒ
<br />

### **Backend**

- **Language**: Java 17
- **Framework**: Spring Boot 3.4.1
- **Database**: MySQL 8.xx
- **ORM**: Spring Data JPA + QueryDSL
- **Authentication**: OAuth2 + JWT
- **Push Notification**: Firebase Cloud Messaging (FCM)

### **Infra & DevOps**

- **CI/CD**: GitHub Actions + Docker + EC2
- **Middleware:** AWS SNS, AWS S3, AWS RDS(8.xx)
- **Monitoring**: (ì˜ˆì •) Spring Actuator, Grafana

---
## 4. ì•„í‚¤í…ì²˜

![ì•„í‚¤í…ì²˜](docs/images/architecture.png)

---
## 5. ì£¼ìš” ê¸°ëŠ¥
<br />

| **ê¸°ëŠ¥** | **ì„¤ëª…** |
| --- | --- |
| **ì˜ˆì•½ ë“±ë¡** | íšŒì›ì´ ì„¸ì…˜ì„ ì„ íƒí•´ ì˜ˆì•½ ìš”ì²­ |
| **ê³ ì • ì˜ˆì•½** | ì„¸ì…˜ì´ ëª¨ë‘ ì†Œì§„ë  ë•Œê¹Œì§€ ë™ì¼ ìš”ì¼, ì‹œê°„ìœ¼ë¡œ ë°˜ë³µ ì˜ˆì•½ ìë™ ìƒì„± |
| **ì˜ˆì•½ ì·¨ì†Œ** | ì·¨ì†Œ ì‚¬ìœ  ë° ìŠ¹ì¸ ì ˆì°¨ í¬í•¨ |
| **ì˜ˆì•½ ë³€ê²½ ìš”ì²­** | ê¸°ì¡´ ì˜ˆì•½ì— ëŒ€í•œ ì‹œê°„ ë³€ê²½ ìš”ì²­ ê¸°ëŠ¥ |
| **íœ´ë¬´ ì„¤ì •** | íŠ¸ë ˆì´ë„ˆê°€ íŠ¹ì • ë‚ ì§œë¥¼ íœ´ë¬´ë¡œ ì„¤ì •í•˜ë©´ í•´ë‹¹ì¼ ì˜ˆì•½ ë¶ˆê°€ ì²˜ë¦¬ |
| **ì•Œë¦¼ ê¸°ëŠ¥** | ì˜ˆì•½ í™•ì •, ë³€ê²½, ì·¨ì†Œ ì‹œ íšŒì›/íŠ¸ë ˆì´ë„ˆì—ê²Œ ì‹¤ì‹œê°„ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ |
| **ìš´ì˜ ì‹œê°„ ê´€ë¦¬** | íŠ¸ë ˆì´ë„ˆê°€ ìš”ì¼ë³„ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì • ê°€ëŠ¥ |
| **ì„ í˜¸ ì‹œê°„ ì„¤ì •** | íšŒì›ì´ ìš´ë™í•˜ê¸° ì¢‹ì€ ì„ í˜¸ ì‹œê°„ ë“±ë¡ ê°€ëŠ¥ |

---
## 6. ê¸°ëŠ¥ ëª…ì„¸ ë° ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
<br />

### íŠ¸ë ˆì´ë„ˆ ê¸°ëŠ¥ ëª…ì„¸

[íŠ¸ë ˆì´ë„ˆ_ê¸°ëŠ¥_ëª…ì„¸](https://docs.google.com/spreadsheets/d/1Cix12FeJTmoz3gzzo4VPtI6R5A02McWfG6qDqzWzJbE/edit?gid=0#gid=0)

### íšŒì› ê¸°ëŠ¥ ëª…ì„¸
[íšŒì›_ê¸°ëŠ¥_ëª…ì„¸](https://docs.google.com/spreadsheets/d/1LKWKU2DC2aeEGF3aiv0lQzqPqj3zJaA_4RqLQuoKgOM/edit?usp=sharing)

### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 1
![ì‹œí€€ìŠ¤1](docs/images/sequence1.png)
### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 2
![ì‹œí€€ìŠ¤1](docs/images/sequence2.png)
### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 3
![ì‹œí€€ìŠ¤1](docs/images/sequence3.png)
### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 4
![ì‹œí€€ìŠ¤1](docs/images/sequence4.png)
### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 5
![ì‹œí€€ìŠ¤1](docs/images/sequence5.png)

---
## 7. API ëª…ì„¸ì„œ
<br />

### **API ëª…ì„¸ì„œ**
[FitLink API Docs](https://documenter.getpostman.com/view/19533799/2sAYX6qhbN#43e2212b-4474-433f-81a1-48fc9f4be977)

---
## 8. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
<br />

## 8-1. ì•Œë¦¼ ë°œì†¡ íŠ¸ëœì­ì…˜ ë¶„ë¦¬

### 8-1-1. ë¬¸ì œ

ê¸°ì¡´ì— ì•Œë¦¼ ë°œì†¡ ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class NotificationService {
  private final NotificationStrategyHandler strategyHandler;
  ...

  @Transactional
  public <T extends NotificationRequest> void sendNotification(T request) {
      // 1. DB ì €ì¥
      Notification notification = strategyHandler.handle(request);
      notificationRepository.save(notification);
      // 2. push ì•Œë¦¼ ì „ì†¡
      pushNotificationClient.pushNotification(token, title, content);
  }
}
```

ì´ ë¡œì§ì€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤.

- ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì¸µê³¼ ì¸í”„ë¼ ê³„ì¸µì˜ ì‹œìŠ¤í…œì´ **ê°•í•˜ê²Œ ê²°í•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.**

ë”°ë¼ì„œ ì‹œìŠ¤í…œì˜ ë³µì¡ë„ê°€ ì˜¬ë¼ê°ˆ ë¿ë§Œ ì•„ë‹ˆë¼ ë§Œì•½ì— push ì•Œë¦¼ ì „ì†¡ ë„ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´ ìœ„ì— ì•Œë¦¼ ì €ì¥ ë¡œì§ë„ **ë¡¤ë°±ì´ ë˜ê²Œ ë©ë‹ˆë‹¤.**

í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ â€˜ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜, ëª¨ë‘ ì‹¤íŒ¨í•´ì•¼í•œë‹¤.â€™ ë¼ëŠ” ì ì—ì„œëŠ” ë§ëŠ” ë¡œì§ì´ì§€ë§Œ, ì™¸ë¶€ ì‹œìŠ¤í…œì— ì˜í•´ì„œ DB ë¡œì§ì´ ì‹¤íŒ¨í•˜ëŠ”ê±´ **í•µì‹¬ë¡œì§ì´ ë¶€ê°€ë¡œì§ì— ì˜¤ì—¼ëœ ê²ƒì²˜ëŸ¼ ë³´ì˜€ìŠµë‹ˆë‹¤.**

### 8-1-2. ì›ì¸

ìƒê°í•´ë³´ë©´, ìœ„ ë¡œì§ì€ **ë‹¨ì¼ì±…ì„ì›ì¹™ì„** ìœ„ë°°í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.

**â€œí•˜ë‚˜ì˜ ëª¨ë“ˆì€ í•˜ë‚˜ì˜ ì±…ì„ë§Œ ê°€ì ¸ì•„ í•œë‹¤.â€**

ìœ„ ë¡œì§ì„ ì‚´í´ë³´ë©´

- DBì— ì•Œë¦¼ ì •ë³´ ì €ì¥ **(í•µì‹¬ ë¡œì§)**
- psuh ì•Œë¦¼ ì „ì†¡ **(ë¶€ê°€ ë¡œì§)**

ë‘ê°€ì§€ **ì±…ì„ì„** ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ë¡œì§ì„ ë¶„ë¦¬í•  í•„ìš”ê°€ ìˆì–´ ë³´ì…ë‹ˆë‹¤.

### 8-1-3. í•´ê²°ë°©ë²•

**EDA**ë¥¼ ë„ì…í•˜ì—¬ ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ê³  í•˜ì˜€ìŠµë‹ˆë‹¤.

### **EDAë€?**

- **Event-Driven Architecture (ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜)**
- ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œë“¤ì´ **ì´ë²¤íŠ¸(event)** ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ **ìƒì„± â†’ ì „ë‹¬ â†’ ì²˜ë¦¬**ë˜ëŠ” êµ¬ì¡°
- ì´ë²¤íŠ¸: ì‹œìŠ¤í…œ ë‚´ì—ì„œ ë°œìƒí•œ ì–´ë–¤ **ìƒíƒœ ë³€í™”ë‚˜ í–‰ë™ (ì˜ˆ: ì£¼ë¬¸ ì™„ë£Œ, ê²°ì œ ì„±ê³µ)**

ì´ê²ƒì„ ë„ì…í•˜ë©´ ì‹œìŠ¤í…œê°„ì˜ ë³µì¡ë„ë¥¼ ë‚®ì¶° **ëŠìŠ¨í•œ ê²°í•©**ê³¼ **í™•ì¥ì„±**ì— ìœ ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  EDAë¥¼ ë„ì…í•˜ë©´ ì´ë²¤íŠ¸ ë‹¨ìœ„ë¡œ ì±…ì„ì´ ë¶„ì‚°ë˜ë¯€ë¡œ, ìì—°ìŠ¤ëŸ½ê²Œ ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬ê°€ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤.

ìŠ¤í”„ë§ì—ì„œ ì§€ì›í•˜ëŠ” `ApplicationEventPublisher` ì™€ `EventListener` ë¥¼ í™œìš©í•˜ë©´ ì¶©ë¶„íˆ ì´ë²¤íŠ¸ ë“œë¦¬ë¸í•˜ê²Œ ìœ„ ìƒí™©ì„ í•´ê²°í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

### 8-1-4. ì ìš©

ë°”ë€ ë¡œì§ì„ ë³´ë©´

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class NotificationService {
    private final NotificationRepository notificationRepository;
    private final NotificationStrategyHandler strategyHandler;
    private final PushNotificationClient pushNotificationClient;
    private final ApplicationEventPublisher publisher;

   ...

  @Transactional
  public <T extends NotificationRequest> void sendNotification(T request) {
      // 1. DB ì €ì¥
      Notification notification = strategyHandler.handle(request);
      notificationRepository.save(notification);
      // 2. push ì•Œë¦¼ ì „ì†¡ ì´ë²¤íŠ¸ë¡œ ì „ë‹¬
      publisher.publishEvent(PushEvent.builder()
              .pushToken(request.getPushToken())
              .name(notification.getName())
              .content(notification.getContent())
              .build());
  }
    
   public void pushNotification(String token, String title, String content) {
      pushNotificationClient.pushNotification(token, title, content);
  }
 ... 
}
```

ì´ë²¤íŠ¸ê°€ ë°œí–‰ë˜ë©´, ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ê³³ì—ì„œ ê·¸ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
public class NotificationEventListener {

    private final NotificationService notificationService;

    @Async
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void onPushEvent(PushEvent event) {
        notificationService.pushNotification(event.pushToken(), event.name(), event.content());
    }
}
```

ì—¬ê¸°ì„œ `@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)` ì´ ì˜µì…˜ì„ í†µí•´, **DB ë¡œì§ì´ commitì´ ëœ í›„**, ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ `pushNotificationClient.pushNotification(token, title, content);` ì´ ë¡œì§ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„, í•µì‹¬ ë¡œì§ì€ ë³´í˜¸ ë°›ê²Œ ë©ë‹ˆë‹¤.

ë‹¤ë§Œ, ì•Œë¦¼ ì „ì†¡ì´ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°, **retry ë¡œì§ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡ì„ ë³´ì¥í•´ì£¼ëŠ” ë¡œì§ì„ ë³´ì™„í•´ì•¼í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.**

## 8-2. @Validê°€ ë™ì‘í•˜ì§€ ì•ŠìŒ
<br />

### 8-2-1. ë¬¸ì œ

í…ŒìŠ¤íŠ¸ì½”ë“œë¥¼ ì‘ì„± í›„, í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë˜ ì¤‘ ì´ìƒí•œ ì ì„ ë°œê²¬í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
@RoleCheck(allowedRoles = {UserRole.TRAINER})
@PostMapping("/{reservationId}/approve")
public ApiResultResponse<ReservationResponseDto.Success> approveReservation(@PathVariable("reservationId")
                                                                            @NotNull(message = "ì˜ˆì•½ IDëŠ” í•„ìˆ˜ê°’ì…ë‹ˆë‹¤.")
                                                                            Long reservationId,
                                                                            @RequestBody @Valid
                                                                            ReservationRequestDto.Approve
                                                                                    request,
                                                                            @Login SecurityUser user
) {
    Reservation result = reservationFacade.approveReservation(request.toCriteria(reservationId), user);

    return ApiResultResponse.ok(ReservationResponseDto.Success.of(result));

}
```

```java
public class ReservationRequestDto {
	...
	
	@Builder(toBuilder = true)
	public record Approve(@NotNull(message = "ìœ ì € IDëŠ” í•„ìˆ˜ê°’ ì…ë‹ˆë‹¤.") Long memberId,
	                      @NotNull(message = "ìš”ì²­ ë‚ ì§œëŠ” ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
	                      @FutureOrPresent(message = "í˜„ì¬ ë‚ ì§œë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
	                      LocalDateTime reservationDate) {
	    public ReservationCriteria.Approve toCriteria(Long reservationId) {
	
	        return ReservationCriteria.Approve.builder()
	                .reservationId(reservationId)
	                .memberId(memberId)
	                .reservationDate(reservationDate)
	                .build();
	    }
	}
	
 ...
}

```

ì˜ˆì™¸ëŠ” ê³µí†µìœ¼ë¡œ `@RestControllerAdvice` ë¥¼ ì‘ì„±í•˜ì—¬ ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
@RestControllerAdvice
@Slf4j(topic = "ExceptionLogger")
public class ApiControllerAdvice {

    @ResponseStatus(HttpStatus.OK)
    @ExceptionHandler(CustomException.class)
    public ApiResultResponse<Object> handlerCustomException(CustomException e) {
        log.error("CustomException is occurred! {}", e.getMessage());
        return ApiResultResponse.of(HttpStatus.valueOf(e.getStatus()), false, e.getMessage(), null);
    }
    
    @ResponseStatus(HttpStatus.OK)
    @ExceptionHandler(HandlerMethodValidationException.class)
    public ApiResultResponse<Object> handlerMethodValidationException(HandlerMethodValidationException e) {
        log.error("HandlerMethodValidationException is occurred! {}", e.getMessage());
        return ApiResultResponse.of(HttpStatus.BAD_REQUEST, false, e.getMessage(), null);
    }
    ...
    
}
```

```java
@WebMvcTest(ReservationController.class)
class ReservationControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @MockitoBean
    private ReservationFacade reservationFacade;

    @MockitoBean
    private AuthTokenProvider authTokenProvider;

    @MockitoBean
    private PersonalDetailRepository personalDetailRepository;

    @MockitoBean
    private LoginMemberArgumentResolver loginMemberArgumentResolver;

...

@Nested
@DisplayName("ì˜ˆì•½ ìŠ¹ì¸ Controller TEST")
class ApproveReservationControllerTest {
    
    ...

    @Test
    @DisplayName("íŠ¸ë ˆì´ë„ˆì˜ ì˜ˆì•½ ì‹¤íŒ¨ - ë©¤ë²„ ID ë¶€ì¬")
    void approveReservationWithNoMemberId() throws Exception {
        //given
        ReservationRequestDto.Approve request = ReservationRequestDto.Approve.builder()
                .reservationDate(LocalDateTime.now().plusSeconds(2))
                .build();

        Long reservationId = 1L;

        Reservation result = Reservation.builder()
                .reservationId(1L)
                .status(RESERVATION_APPROVED)
                .build();

        PersonalDetail personalDetail = PersonalDetail.builder()
                .personalDetailId(1L)
                .name("ë©¤ë²„1")
                .memberId(1L)
                .trainerId(null)
                .build();

        SecurityUser user = new SecurityUser(personalDetail);

        String accessToken = getAccessToken(personalDetail);

        when(reservationFacade.approveReservation(any(ReservationCriteria.Approve.class),
                any(SecurityUser.class))).thenReturn(result);

        //when & then
        mockMvc.perform(post("/v1/reservations/%s/approve".formatted(reservationId))
                        .header("Authorization", "Bearer " + accessToken)
                        .with(oauth2Login().oauth2User(user))
                        .with(csrf())
                        .content(objectMapper.writeValueAsString(request))
                        .contentType(MediaType.APPLICATION_JSON))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.status").value(400))
                .andExpect(jsonPath("$.success").value(false))
                .andExpect(jsonPath("$.msg").value("ìœ ì € IDëŠ” í•„ìˆ˜ê°’ ì…ë‹ˆë‹¤."))
                .andExpect(jsonPath("$.data").isEmpty());
      }
  }
  
  ...
}

```

ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ëŒë ¤ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤.

```java
Resolved Exception:
             Type = org.springframework.web.method.annotation.HandlerMethodValidationException
...

JSON path "$.msg"
Expected :ìœ ì € IDëŠ” í•„ìˆ˜ê°’ ì…ë‹ˆë‹¤.
Actual   :400 BAD_REQUEST "Validation failure"
```

ì œê°€ ê¸°ëŒ€í•˜ëŠ” ê±´ `â€˜ìœ ì € IDëŠ” í•„ìˆ˜ê°’ ì…ë‹ˆë‹¤.â€™` ë¼ëŠ” ë©”ì„¸ì§€ì¸ë° `400 BAD_REQUEST "Validation failure"` ê°€ ì‹¤ì œë¡œ ì¶œë ¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¡œê·¸ë¥¼ ë³´ë©´ `HandlerMethodValidationException` ê°€ ë°œìƒí•˜ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆê³ , `@RestControllerAdvice` ì—ì„œ í•´ë‹¹ `Exception`ì„ ì¡ì•„ì„œ ì²˜ë¦¬ë¥¼ í•´ì¤¬ìŠµë‹ˆë‹¤.

`@Valid` ì„ í†µí•´ `@RequestBody` ë¥¼ ìœ íš¨ì„± ê²€ì¦ì„ í–ˆëŠ”ë°, ì™œ ì›í•˜ëŠ” ë©”ì„¸ì§€ê°€ ì¶œë ¥ì´ ë˜ì§ˆ ì•ŠëŠ”ì§€ ì´í•´ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### 8-2-2. ì›ì¸

### **ê¸°ì¡´ì˜ Springì˜ @Valid ì–´ë…¸í…Œì´ì…˜ì´ ë™ì‘í•˜ëŠ” ê³¼ì •**

![ts1](docs/images/ts1.png)

![ts2](docs/images/ts2.png)

ìŠ¤í”„ë§ì—ì„œ Dispatcher Servletì€ **RequestMapping í•¸ë“¤ëŸ¬ ì–´ëŒ‘í„°**ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ìœ íš¨ì„± ê²€ì¦ì„ ìœ„í•œ Validatorë¥¼ ë¯¸ë¦¬ ë“±ë¡í•´ë‘ê³ , ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ **ArgumentResolver**ë¥¼ í˜¸ì¶œí•´ì„œ `@RequestParam, @RequestBody, @ModelAttribute` ë“± ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  í•„ë“œë¥¼ ê²€ì¦í•˜ê²Œ ë©ë‹ˆë‹¤.

ì¤‘ìš”í•œ ì ì€ `@RequestParam, @RequestBody`ì— ëŒ€í•œ ê²€ì¦ì„ SpringBoot3.2 ì´ì „ ë²„ì „ì—ì„œëŠ” ArgumentResolver í•˜ë‚˜ê°€ **ëª¨ë‘ ìœ„ì„ ë°›ëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤**.

ë”°ë¼ì„œ `@NotNull, @Blank, @Size` ì™€ ê°™ì€ Constraint ì–´ë…¸í…Œì´ì…˜ì„ parameter í˜¹ì€ bodyì— ë¶™ì—¬ì£¼ê¸°ë§Œ í•˜ë©´ í•„ë“œ ìœ íš¨ì„± ê²€ì¦ì´ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.

### **SpringBoot3 ë²„ì „ì—ì„œ @RequestBodyì— ëŒ€í•œ @Vaild ìœ íš¨ì„± ê²€ì¦**

ìŠ¤í”„ë§ ë¶€íŠ¸3(ì—„ë°€íˆëŠ” ìŠ¤í”„ë§ 6.1)ë¶€í„° Spring MVCì™€ WebFluxì—ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìœ„í•œ`@Constraint` ê´€ë ¨ ì• ë…¸í…Œì´ì…˜ì„ **ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•˜ë„ë¡ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.**

![ts3](docs/images/ts3.png)

ê¸°ì¡´ì— ì²˜ë¦¬ ê³¼ì •ê³¼ ë™ì¼í•˜ê²Œ `ArgumentResolver`ë“¤ì´ ëª¨ë‘ ë™ì‘í•˜ê³ , ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë©”ì„œë“œ í˜¸ì¶œì´ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ ìœ íš¨ì„± ê²€ì‚¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤. ìŠ¤í”„ë§ì€ ì´ë¥¼ **`MethodValidator`** ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.

### ìƒˆë¡œìš´ ìœ íš¨ì„± ê²€ì‚¬ ê¸°ëŠ¥(MethodValidator) ì‚¬ìš©ë²•

ìŠ¤í”„ë§ì˜ `MethodValidator` ê´€ë ¨ ê¸°ëŠ¥ì„ í™œìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒì˜ ì¡°ê±´ë“¤ì´ ì¶©ì¡±ë˜ë©´ ë©ë‹ˆë‹¤.

1. ì»¨íŠ¸ë¡¤ëŸ¬ì— @Validatedë¥¼ í†µí•œ AOP ê¸°ë°˜ ê²€ì¦ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
2. LocalValidatorFactoryBeanì™€ ê°™ì€ jakarta.validation.Validator íƒ€ì…ì˜ ë¹ˆì´ ë“±ë¡ë¨
3. ë©”ì„œë“œ íŒŒë¼ë¯¸í„°ì— ìœ íš¨ì„± ê²€ì¦ ì• ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆìŒ

ë”°ë¼ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ 3.2 ì´ìƒ ì´ë¼ë©´  `@Valid` ë˜ëŠ” `@Validated`ë¥¼ ë¶™ì—¬ì¤„ í•„ìš” ì—†ì´ ê¸°ë³¸ì ì¸ ìœ íš¨ì„± ê²€ì¦ì´ ë™ì‘í•˜ê²Œ ë©ë‹ˆë‹¤.

ì´ë•Œë¶€í„° `HandlerMethodValidationException` ê°€ ì¶”ê°€ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

ì´ ì‚¬ì‹¤ì€ ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œì—ë„ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> Spring MVC has built-inÂ [validation](https://docs.spring.io/spring-framework/reference/core/validation/validator.html)Â forÂ `@RequestMapping`Â methods, includingÂ [Java Bean Validation](https://docs.spring.io/spring-framework/reference/core/validation/beanvalidation.html). Validation may be applied at one of two levels:
>
>
> 1. [@ModelAttribute](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/modelattrib-method-args.html),Â [@RequestBody](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/requestbody.html), andÂ [@RequestPart](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/multipart-forms.html)Â argument resolvers validate a method argument individually if the method parameter is annotated with JakartaÂ `@Valid`Â or Springâ€™sÂ `@Validated`,Â *AND*Â there is noÂ `Errors`Â orÂ `BindingResult`Â parameter immediately after,Â *AND*Â method validation is not needed (to be discussed next). The exception raised in this case isÂ `MethodArgumentNotValidException`.
> 2. WhenÂ `@Constraint`Â annotations such asÂ `@Min`,Â `@NotBlank`Â and others are declared directly on method parameters, or on the method (for the return value), then method validation must be applied, and that supersedes validation at the method argument level because method validation covers both method parameter constraints and nested constraints viaÂ `@Valid`. The exception raised in this case isÂ **`HandlerMethodValidationException`**.
>
<br />

`HandlerMethodValidationException` ì˜ ìœ íš¨ì„± ê²€ì¦ ê³¼ì •ì„ ìì„¸íˆ ì‚´í´ë³´ë©´

```java
@SuppressWarnings("serial")
public class HandlerMethodValidationException extends ResponseStatusException implements MethodValidationResult {

	private final MethodValidationResult validationResult;

	private final Predicate<MethodParameter> modelAttributePredicate;

	private final Predicate<MethodParameter> requestParamPredicate;

	public HandlerMethodValidationException(MethodValidationResult validationResult) {
		this(validationResult,
				param -> param.hasParameterAnnotation(ModelAttribute.class),
				param -> param.hasParameterAnnotation(RequestParam.class));
	}
```

`HandlerMethodValidationException`ì˜ ìƒì„±ìë¥¼ ë³´ë©´ `@ModelAttribute`ì™€ `@RequestParam`ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì¦ ì²˜ë¦¬ë§Œì„ ì „ë‹¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë°˜ë©´, `@RequestBody`ë‚˜ `@PathVariable` ë“±ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì¦ì€ **ì œì™¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.**

### 8-2-3. í•´ê²°ë°©ë²•

`HandlerMethodValidationException` ì—ì„œ ë”ì´ìƒ `@RequestBody` ì— ëŒ€í•´ì„œ ìœ íš¨ì„± ê²€ì¦ì„ ë‹´ë‹¹í•˜ê³  ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— ì§ì ‘ ë©”ì„¸ì§€ë¥¼ í•¸ë“¤ë§ í•´ì£¼ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

<br />
ì´ ë°©ì‹ì€ ìŠ¤í”„ë§ ê³µì‹ë¬¸ì„œì—ì„œë„ ê¶Œì¥í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

> **For further custom handling of method validation errors, you can extendÂ `ResponseEntityExceptionHandler`Â or use anÂ `@ExceptionHandler`Â method in a controller or in aÂ `@ControllerAdvice`, and handleÂ `HandlerMethodValidationException`Â directly.** The exception contains a list ofÂ `ParameterValidationResult`s that group validation errors by method parameter. You can either iterate over those, or provide a visitor with callback methods by controller method parameter type:
>

<br />

ê·¸ë˜ì„œ ë””ë²„ê¹…ì„ í†µí•´ ìœ„ ë‚´ìš©ì´ ì‚¬ì‹¤ì¸ì§€ í™•ì¸í•´ ë³´ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë””ë²„ê¹… ëª¨ë“œë¡œ ëŒë ¤ì„œ breakPointë¥¼ ì—ëŸ¬ë¥¼ í•¸ë“¤ë§ í•˜ëŠ”ê³³ì— ì¡ì•„ë‘ê³ ,

![ts4](docs/images/ts4.png)

ë””ë²„ê¹…ì— ì°íˆëŠ” ê°’ì„ í™•ì¸í•´ ë³´ë©´

![ts5](docs/images/ts5.png)

`ParameterValidationResults -> getResolvableErrors -> getDefaultMessage` ì— ë“¤ì–´ê°€ë³´ë©´ ì œê°€ ì„¤ì •í•œ ë©”ì„¸ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### 8-2-4. ì ìš©

ëˆˆìœ¼ë¡œ í™•ì¸í–ˆìœ¼ë‹ˆ, ë‹¤ìŒ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì œ ë©”ì„¸ì§€ë¥¼ ë°˜í™˜í•´ì£¼ëŠ” ì‘ì—…ë§Œ í•´ì£¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```java
public class MessageConvertUtils {

    /**
     * DTOì—ì„œ ê°’ì„ ê²€ì¦í•  ë•Œ ë©”ì‹œì§€ë¥¼ ì„¤ì •í–ˆì„ ê²½ìš° ê·¸ ë©”ì‹œì§€ë§Œ ë‚˜ì˜¤ê²Œ ë³€í™˜
     *
     * @return ë‚´ê°€ ì„¤ì •í•œ ë©”ì‹œì§€
     */
    public static String getErrorCustomMessage(Exception e) {

        if (e instanceof HandlerMethodValidationException exception) {
            return exception.getParameterValidationResults().stream()  // getValidationResults() ì‚¬ìš©
                    .map(ParameterValidationResult::getResolvableErrors)
                    .flatMap(Collection::stream)
                    .map(MessageSourceResolvable::getDefaultMessage)
                    .collect(Collectors.collectingAndThen(Collectors.joining(", "),
                            msg -> msg.isEmpty() ? "ë³´ë‚´ëŠ” íŒŒë¼ë¯¸í„°ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”." : msg));
        }
        
        return e.getMessage();
    }
}

```

ë‹¤ìŒ ìœ í‹¸ í•¨ìˆ˜ë¥¼ ì ìš©í•˜ë©´,

```java
@RestControllerAdvice
@Slf4j(topic = "ExceptionLogger")
public class ApiControllerAdvice {

    @ResponseStatus(HttpStatus.OK)
    @ExceptionHandler(CustomException.class)
    public ApiResultResponse<Object> handlerCustomException(CustomException e) {
        log.error("CustomException is occurred! {}", e.getMessage());
        return ApiResultResponse.of(HttpStatus.valueOf(e.getStatus()), false, e.getMessage(), null);
    }
    
    @ResponseStatus(HttpStatus.OK)
    @ExceptionHandler(HandlerMethodValidationException.class)
    public ApiResultResponse<Object> handlerMethodValidationException(HandlerMethodValidationException e) {
        log.error("HandlerMethodValidationException is occurred! {}", e.getMessage());
        return ApiResultResponse.of(HttpStatus.BAD_REQUEST, false, getErrorCustomMessage(e), null);
    }
    ...
    
}
```

ê·¸ë¦¬ê³  ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ëŒë ¤ë³´ë©´ ê²°ê³¼ëŠ”

```java
MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Type:"application/json", X-Content-Type-Options:"nosniff", X-XSS-Protection:"0", Cache-Control:"no-cache, no-store, max-age=0, must-revalidate", Pragma:"no-cache", Expires:"0", X-Frame-Options:"DENY"]
     Content type = application/json
             Body = {"status":400,"success":false,"msg":"ìœ ì € IDëŠ” í•„ìˆ˜ê°’ ì…ë‹ˆë‹¤.","data":null}
    Forwarded URL = null
   Redirected URL = null
          Cookies = []
```

ì„¤ì •í•œ ë©”ì„¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


---
## 9. ê°œë°œ ì¤‘ ê³ ë¯¼ê³¼ í•´ê²°
<br />

## 9-1. ê³ ì • ì˜ˆì•½ ë¡œì§


### 9-1-1. ë§¤ì¼ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‹¤í–‰

ì²˜ìŒ ê³ ì • ì˜ˆì•½ì„ ê¸°ëŠ¥ ëª…ì„¸ë¡œ ë´¤ì„ ë•Œ ë“¤ì—ˆë˜ ìƒê°ì€, **â€˜ë§¤ì¼ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìì •ì— ëŒì•„ì„œ, ë‹¹ì¼ì— ê³ ì • ì˜ˆì•½ìœ¼ë¡œ ì¡í˜€ ìˆëŠ” ì˜ˆì•½ë“¤ì„ ì„ ë³„í•˜ì—¬, ì¼ì£¼ì¼ ë’¤ì— ì˜ˆì•½ì„ ì¡ì•„ì£¼ë©´ ë˜ê² ë‹¤.â€™** ì´ì˜€ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì„¤ì •í•˜ê³ ,

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class FixedReservationScheduler { //

    private final ReservationFacade reservationFacade;

    /**
     * ë§¤ì¼ ì •ê°ë§ˆë‹¤ ê³ ì • ì˜ˆì•½ í™•ì¸í•˜ê³ , ì˜ˆì•½ ì‹¤í–‰ (ì¼ì£¼ì¼ ë’¤ì— ê³ ì • ì˜ˆì•½ í•¨)
     */
    @Scheduled(cron = "0 0 0 * * *") // ë§¤ì¼ 00:00:00ì— ì‹¤í–‰
    public void fixedReserveSession() {
        reservationFacade.checkFixedReserveSession();
    }
}
```

ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
public class ReservationFacade {

...

	@Transactional
	public void checkFixedReserveSession() {
	    // ê³ ì • ì˜ˆì•½ ìƒíƒœì˜ ì˜ˆì•½ ì¡°íšŒ
	    List<Reservation> fixedReservations = reservationService.getFixedReservations();
	
	    // ì¼ì£¼ì¼ ë’¤ì— ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½ ë„ë©”ì¸ ìƒì„±
	    List<Reservation> newReservations = fixedReservations.stream()
	            .map(Reservation::toFixedDomain)
	            .toList();
	    // ì¼ì£¼ì¼ ë’¤ì— ì‹œê°„ì— ì˜ˆì•½ì´ ìˆë‹¤ë©´(ì˜ˆì•½ ëŒ€ê¸° í¬í•¨) ì·¨ì†Œ ì ˆì°¨ ì§„í–‰
	    newReservations.forEach((r) -> {
	        List<Reservation> getThatTimeReservations = reservationService.getReservationThatTimes(
	                ReservationCommand.GetReservationThatTimes.builder()
	                        .trainerId(r.getTrainer().getTrainerId())
	                        .date(r.getReservationDates())
	                        .build());
	
	        cancelExistingReservations(getThatTimeReservations, "íŠ¸ë ˆì´ë„ˆì˜ ê³ ì • ì˜ˆì•½ìœ¼ë¡œ ì¸í•´ ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
	    });
	    // ê³ ì • ì˜ˆì•½ ì§„í–‰
	    reservationService.fixedReserveSessions(newReservations);
	}
	
	private void cancelExistingReservations(List<Reservation> reservations, String cancelMsg) {
	    if (!reservations.isEmpty()) {
	        reservations.forEach(Reservation::checkPossibleReserveStatus);
	        // ë§Œì•½ ì˜ˆì•½ì´ ìˆë‹¤ë©´, ê·¸ ì˜ˆì•½ë“¤ ëª¨ë‘ ê°•ì œë¡œ ì·¨ì†Œ
	        reservationService.cancelReservations(reservations, cancelMsg);
	        // ì·¨ì†Œí–ˆë‹¤ë©´, ì·¨ì†Œëë‹¤ëŠ” ì•ŒëŒ ì „ì†¡
	        reservations.forEach(r -> notificationService.sendCancelReservationNotification(r.getReservationId(),
	                memberService.getMemberDetail(r.getMember().getMemberId()), RESERVATION_REFUSE));
	    }
	}
...
}

```

ê·¸ëŸ°ë° ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ë³´ë‹ˆ ë¬¸ì œì ì´ ë³´ì˜€ìŠµë‹ˆë‹¤.

- ì¼ì£¼ì¼ ë’¤ì— ê·¸ ì‹œê°„ì— ì˜ˆì•½ì´ ìˆë‹¤ë©´ ê·¸ ì˜ˆì•½ì„ ì·¨ì†Œì‹œì¼œì•¼í• ê¹Œ?
    - ì˜ˆì•½ì˜ ìš°ì„  ìˆœìœ„ê°€ ê³ ì •ì˜ˆì•½ì´ ê°€ì¥ ë†’ì„ê¹Œ?
- ë§Œì•½ ê·¸ë‚ ì— ê³ ì • ì˜ˆì•½ì´ 2ê°œê°€ ìˆëŠ”ë°, ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ëŒë‹¤ê°€ ì—ëŸ¬ê°€ ë‚˜ë©´ ë‘˜ ë‹¤ ì‹¤íŒ¨í•´ë²„ë¦¬ë„¤?
    - ê°ê°ì˜ ê³ ì • ì˜ˆì•½ì€ ë…ë¦½ì ìœ¼ë¡œ ì˜ˆì•½ì´ ë˜ì–´ì•¼ í•˜ì§€ ì•Šì„ê¹Œ?
    - ë§Œì•½ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ë‹¤ì‹œ ì‹œë„í•˜ëŠ” ë¡œì§ì´ ìˆì–´ì•¼í•˜ì§€ ì•Šì„ê¹Œ?

### 9-1-2. SQSë¡œ ë¡œì§ ì´ê´€

ìœ„ì™€ ê°™ì€ ê³ ë¯¼ ë•Œë¬¸ì— ë‹¤ìŒê³¼ ê°™ì´ ë¬¸ì œì ì„ í•´ê²°í•˜ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

- ì¼ì£¼ì¼ ë’¤ì— ê·¸ ì‹œê°„ì— ì˜ˆì•½ì´ ìˆë‹¤ë©´ ê·¸ ì˜ˆì•½ì„ ì·¨ì†Œì‹œì¼œì•¼í• ê¹Œ?

â†’ **í™•ì •ëœ ì˜ˆì•½ì´ ì•„ë‹Œ ëŒ€ê¸° ì¤‘ì¸ ì˜ˆì•½ì´ ìˆë‹¤ë©´** ê±°ì ˆì‹œí‚¤ê³ , ê·¸ ë‚˜ë¨¸ì§€ ê²½ìš°ì—ëŠ” ê³ ì • ì˜ˆì•½ì„ ì§„í–‰ì‹œí‚¤ì!

- ë§Œì•½ ê·¸ë‚ ì— ê³ ì • ì˜ˆì•½ì´ 2ê°œê°€ ìˆëŠ”ë°, ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ëŒë‹¤ê°€ ì—ëŸ¬ê°€ ë‚˜ë©´ ë‘˜ ë‹¤ ì‹¤íŒ¨í•´ë²„ë¦¬ë„¤?

â†’ ê°ê°ì˜ ê³ ì • ì˜ˆì•½ì„ í•˜ë‚˜ì˜ í…ŒìŠ¤í¬ë¡œ ì¸ì‹í•˜ê³ , **Queue**ë¥¼ í†µí•´ì„œ ê³ ì • ì˜ˆì•½ì„ ì§„í–‰ì‹œí‚¤ì!

Queue ê¸°ë°˜ìœ¼ë¡œ ê³ ì •ì˜ˆì•½ ì‘ì—…ì„ ì„ íƒí•œ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. **ì‹¤íŒ¨ ë¶„ë¦¬**
- ê°œë³„ ì‘ì—…ìœ¼ë¡œ ë¶„ë¦¬ë˜ê¸° ë•Œë¬¸ì— **í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ì „ì²´ ì‘ì—…ì—” ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤.**
- ì‹¤íŒ¨í•œ ì‘ì—…ë§Œ ë”°ë¡œ retryí•˜ê±°ë‚˜ alert ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **í™•ì¥ì„±**
- Queue ê¸°ë°˜ êµ¬ì¡°ëŠ” **ì‘ì—…ì´ ë§ì•„ì ¸ë„ ë¶„ì‚° ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.**
    - ë©”ì‹œì§€ ë¸Œë¡œì»¤ (ì˜ˆ: RabbitMQ, SQS, Kafka)
3. **ë¹„ë™ê¸° ì²˜ë¦¬**
- ì‚¬ìš©ì ì…ì¥ì—ì„œ **ì¦‰ê°ì ì¸ ë°˜ì‘** í•„ìš” ì—†ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ìŠ¤í”„ë§ ë‚´ë¶€ì ìœ¼ë¡œ Queueêµ¬ì¡°ë¥¼ ë©”ëª¨ë¦¬ì— ë“±ë¡í•´ì„œ ì‚¬ìš©í•  ìˆ˜ë„ ìˆì§€ë§Œ, ê·¸ëŸ¼ ë˜ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ì´ ê³ ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.

1.  **ì„œë²„ê°€ ì¬ì‹œì‘ë˜ë©´ íê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.**
- ê³ ì • ì˜ˆì•½ ì‘ì—…ì´ queueì— ë“¤ì–´ìˆë‹¤ê°€, ì„œë²„ê°€ ë‹¤ìš´ë˜ë©´ queueì •ë³´ê°€ ì‚¬ë¼ì§€ê²Œ ë©ë‹ˆë‹¤.
    - ì¦‰, **ë¹„ì§€ì†ì„±(non-durable)** êµ¬ì¡°ë¥¼ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.
2. **ë¶„ì‚° í™˜ê²½ì—ì„œ ë™ê¸°í™”ê°€ ì•ˆ ë©ë‹ˆë‹¤.**
- ë§Œì•½ ì„œë²„ 2ëŒ€ ì´ìƒì¸ ë¶„ì‚° í™˜ê²½ì´ë¼ë©´ ì¸ìŠ¤í„´ìŠ¤ ë§ˆë‹¤ queueê°€ ë”°ë¡œ ìˆê²Œ ë˜ê¸° ë•Œë¬¸ì— **ì˜ˆì•½ì´ ì¤‘ë³µë˜ê±°ë‚˜ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
3. **ëª¨ë‹ˆí„°ë§/ì¬ì‹œë„/DLQ ë“± ê³ ê¸‰ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.**
- ì¬ì‹œë„ ë¡œì§, delay, backoff ê°™ì€ ê±¸ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì™¸ë¶€ ë¯¸ë“¤ì›¨ì–´ë¡œ ë™ì‘í•˜ëŠ” Queueë¥¼ ê³ ë ¤í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

- Kafka
- RabbitMQ
- AWS SQS

KafkaëŠ” ìŠ¤íƒ ìì²´ê°€ ë¬´ê²ê³ , ë¹ ë¥´ê²Œ ìŠ¤íŠ¸ë¦¬ë°í•œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ìš©ë„ê°€ ì§€ê¸ˆ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì œì™¸í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚¨ì€ RabbitMQì™€ AWS SQSë¥¼ ë¹„êµí•´ë³´ë©´

| **ê¸°ì¤€** | **RabbitMQ** | **SQS (Amazon Simple Queue Service)** |
| --- | --- | --- |
| ìš´ì˜ ë°©ì‹ | ì§ì ‘ ì„¤ì¹˜ / ê´€ë¦¬ í•„ìš” (EC2ë‚˜ ECS ìœ„ì— ì˜¬ë ¤ì•¼ í•¨) | Fully managed, AWSì—ì„œ ë‹¤ í•´ì¤Œ |
| ë³µì¡ë„ | ë” ìœ ì—°í•˜ì§€ë§Œ ì„¤ì •ê³¼ ìš´ì˜ ë¶€ë‹´ ìˆìŒ | ê°„ë‹¨í•˜ê²Œ ì‹œì‘ ê°€ëŠ¥, ìš´ì˜ ê±°ì˜ ì—†ìŒ |
| ê¸°ëŠ¥ | ê³ ê¸‰ ë¼ìš°íŒ… (topic, fanout ë“±), retry ì„¤ì •ë„ í¼ | ê¸°ë³¸ì ì¸ FIFO, DLQ(Dead Letter Queue)ë§Œ ìˆìŒ |
| Retry | Consumerì—ì„œ ì§ì ‘ ì¬ì‹œë„ êµ¬í˜„í•´ì•¼ í•¨ | DLQ + Visibility Timeoutìœ¼ë¡œ ì¬ì‹œë„ ìœ ë„ ê°€ëŠ¥ |
| Outbox íŒ¨í„´ ì—°ê³„ | ì§ì ‘ ì—°ë™ | AWS DynamoDB Streams, EventBridgeë‘ ì—°ê³„ ì‰¬ì›€ |

ì§€ê¸ˆ ìƒí™©ì—ì„œëŠ” **ì •ë§ ê°„ë‹¨í•œ Queueê¸°ëŠ¥** ì—­í• ë§Œ í•´ì£¼ëŠ” ìŠ¤íƒë§Œ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ìš°ë¦¬ ì„œë²„ëŠ” AWS ìœ„ì— ì˜¬ë¼ê°€ì„œ ìš´ì˜ì´ ë˜ê¸° ë•Œë¬¸ì— ì¢€ ë” AWSì— ì¹œí™”ì ì´ë©´ì„œ ìš´ì˜ì´ ì‰¬ìš´ SQS ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ queue ë©”ì„¸ì§€ ë°œí–‰ì´ ì‹¤íŒ¨í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ **Transactional Outbox Pattern**ë¥¼ ì ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

### **Transactional Outbox Pattern?**

- ë„ë©”ì¸ ë¡œì§ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆë‹¤ë©´, ì´ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ ë©”ì„¸ì§€ë¥¼ `Outbox Table` ì´ë¼ëŠ” ë³„ë„ì˜ í…Œì´ë¸”ì— ì €ì¥í•˜ì—¬ í•¨ê»˜ Commit í•©ë‹ˆë‹¤.
- ë™ì¼í•œ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì´ë²¤íŠ¸ ë°œí–‰ì„ ìœ„í•œ Outbox ë°ì´í„° ì ì¬ê¹Œì§€ ì§„í–‰í•´ ì´ë²¤íŠ¸ ë°œí–‰ì„ ë³´ì¥í•©ë‹ˆë‹¤.
- ì´ë²¤íŠ¸ ë°œí–‰ ìƒíƒœ ë˜í•œ Outbox ë°ì´í„°ì— ì¡´ì¬í•˜ë¯€ë¡œ, ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ ë“±ì„ ì´ìš©í•´ ë¯¸ë°œí–‰ëœ ë°ì´í„°ì— ëŒ€í•œ Fallback ì²˜ë¦¬ê°€ ìš©ì´í•©ë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class ReservationScheduler { //

    private final ReservationFacade reservationFacade;

    /**
     * ë§¤ì¼ ì •ê°ë§ˆë‹¤ ê³ ì • ì˜ˆì•½ í™•ì¸í•˜ê³ , ì˜ˆì•½ ì‹¤í–‰ (ì¼ì£¼ì¼ ë’¤ì— ê³ ì • ì˜ˆì•½ í•¨)
     */
    @Scheduled(cron = "0 0 0 * * *") // ë§¤ì¼ 00:00:00ì— ì‹¤í–‰
    public void createFixedReservations() {
        reservationFacade.checkCreateFixedReservation();
    }
```

```java
@Component
@RequiredArgsConstructor
public class ReservationFacade {

...

	@Transactional
	public void checkCreateFixedReservation() {
	    // ê³ ì • ì˜ˆì•½ ìƒíƒœì˜ ì˜ˆì•½ ì¡°íšŒ
	    reservationService.publishFixedReservations();
	}
    
...    
}
```

```java

@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class ReservationService {

private final ApplicationEventPublisher publisher;

...

   public void publishFixedReservations() {
        // ê³ ì • ì˜ˆì•½ ìƒíƒœì˜ ì˜ˆì•½ ì¡°íšŒ
        List<Reservation> fixedReservations = reservationRepository.getFixedReservations();
        // ì˜¤ëŠ˜ ë‚ ì§œ ê³ ì • ì˜ˆì•½ë“¤ í•„í„°í•˜ê¸°
        List<Reservation> todayFixedReservations = fixedReservations.stream()
                .filter(Reservation::isTodayReservation)
                .toList();
        // ê³ ì • ì˜ˆì•½ê±´ ê°œë³„ ì´ë²¤íŠ¸ ë°œí–‰
        todayFixedReservations.forEach(reservation ->
                publisher.publishEvent(GenerateFixedReservationEvent.builder()
                        .reservationId(reservation.getReservationId())
                        .trainerId(reservation.getTrainer().getTrainerId())
                        .memberId(reservation.getMember().getMemberId())
                        .sessionInfoId(reservation.getSessionInfo().getSessionInfoId())
                        .name(reservation.getName())
                        .confirmDate(reservation.getConfirmDate())
                        .topic(eventTopic.getReservationQueue())
                        .messageId(UUID.randomUUID().toString())
                        .build()));
    }

...    
}
```

```java
@Component
@RequiredArgsConstructor
public class OutboxEventListener {

    private final OutboxService outboxService;
    private final EventProducer eventProducer;

    @TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
    public void saveOutbox(OutboxEvent event) {
        // Outbox data ìƒì„±
        outboxService.createOutbox(event.toOutboxCommand());
    }

    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void publishOutbox(OutboxEvent event) {
        // outbox ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ ì±„í¬
        outboxService.publishOutbox(event.getMessageId());
        // ì´ë²¤íŠ¸ ë©”ì‹œì§€ ë°œí–‰
        eventProducer.publish(event.getTopic(), event.getKey(), event.toPayload());
    }
}
```

```java
@Component
@RequiredArgsConstructor
public class EventProducerImpl implements EventProducer {

    private final SqsProducer sqsProducer;

    @Override
    public void publish(String topic, String key, String payload) {
        sqsProducer.publish(topic, payload);
    }
}
```

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class SqsProducer {

    private final SqsTemplate sqsTemplate;

    public void publish(String topic, String payload) {
        log.info("[SQS] :: PUBLISH :: sending to queue={}, payload={}", topic, payload);

        try {
            sqsTemplate.send(to -> to.queue(topic).payload(payload));
            log.info("[SQS] :: SUCCESS :: queue={}, payload={}", topic, payload);
        } catch (Exception ex) {
            log.error("[SQS] :: FAILED :: queue={}, payload={}, error={}", topic, payload, ex.getMessage(), ex);
        }
    }
}
```

ì´ë ‡ê²Œ êµ¬ì„±í•˜ì˜€ê³ , ìŠ¤ì¼€ì¤„ëŸ¬ë¡œ ë§Œì•½ ì‹¤íŒ¨í•œ ë©”ì„¸ì§€ê°€ ìˆë‹¤ë©´ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ retry í•´ì£¼ê²Œ ì„¤ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class OutboxScheduler {

    private final OutboxService outboxService;

    @Scheduled(fixedDelay = 5 * 60 * 1000) // 5ë¶„ ë§ˆë‹¤ ì‹¤í–‰
    public void retryFailEvent() {
        outboxService.retryFailMessage();
    }
}
```

í…ŒìŠ¤íŠ¸ê¹Œì§€ ëë‚´ê³  ì •ë§ ë§ˆì§€ë§‰ì´ë¼ê³  ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.

### 9-1-3. ê³ ì • ì˜ˆì•½ ë¡œì§ ë³€ê²½

ê·¸ëŸ°ë° ìœ„ì™€ ê°™ì´ ë¡œì§ì„ êµ¬ì„±í•˜ì˜€ì„ ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

- ì§€ê¸ˆ ë¡œì§ì€ ê·¸ ë‚ ì— ê³ ì • ì˜ˆì•½ë“¤ì„ ëª¨ì•„ì„œ ì¼ì£¼ì¼ ë’¤ì— ê°™ì€ ì‹œê°„ëŒ€ ì˜ˆì•½ì„ ì§„í–‰í•˜ëŠ”ë°, ë§Œì•½ ì¼ì£¼ì¼ ë’¤ì— ë‹¤ë¥¸ í™•ì •ëœ ì˜ˆì•½ì´ ìˆë‹¤ë©´?

â†’ ê·¸ ë‹¤ìŒ ê³ ì • ì˜ˆì•½ì„ í•˜ì§€ ëª» í–ˆê¸° ë•Œë¬¸ì— **ê·¸ ê³ ì • ì˜ˆì•½ì€ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì„ ê³„ì† ì˜ˆì•½í•˜ì§€ ëª»í•˜ê³  ë²„ë ¤ì§„ë‹¤.**

ì´ë ‡ê²Œ ìƒê°í•˜ë‹ˆ ì§€ê¸ˆì˜ ê³ ì • ì˜ˆì•½ ë¡œì§ì´ ë¬´ì˜ë¯¸í•˜ë‹¤ëŠ” ëŠë‚Œì„ ë°›ì•˜ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì‹¬í”Œí•˜ê²Œ ì •ì±…ì„ ë‹¤ì‹œ ì •í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

**â€˜ê³ ì • ì˜ˆì•½ ì‹œê°„ì„ ì •í•˜ë©´, ê·¸ íšŒì›ì˜ ì„¸ì…˜ì´ ëª¨ë‘ ì†Œì§„ ë  ë•Œê¹Œì§€ ë¯¸ë¦¬ ì˜ˆì•½ì„ ë‹¤ í•´ë²„ë¦¬ì!â€™**

ì´ë ‡ê²Œ í•˜ë©´ ê°€ì¥ í° ë¬¸ì œê°€ í•´ê²°ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.

ë§Œì•½ ì¤‘ê°„ì— íšŒì›ì´ ìŠ¤ì¼€ì¤„ì„ ë³€ê²½í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ìƒê¸°ë©´ í•´ë‹¹ ë‚ ì§œì˜ ê³ ì • ì˜ˆì•½ì„ ë‹¤ë¥¸ ë‚ ì§œë¡œ ë³€ê²½ ìš”ì²­ì„ í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

íŒ€ì›ë“¤ê³¼ ë‹¤ì‹œ ìƒì˜ë¥¼ í•˜ì˜€ê³ , ì´ ì •ì±…ì„ ìµœì¢…ì ìœ¼ë¡œ ê³ ì • ì˜ˆì•½ì´ ë”°ë¥´ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
public class ReservationFacade {

...

	@Transactional
	public List<Reservation> createFixedReservation(ReservationCriteria.CreateFixed criteria, SecurityUser user) {
    // ì„¸ì…˜ì´ ì¶©ë¶„í•œì§€ í™•ì¸
    memberService.isSessionCountEnough(user.getTrainerId(), criteria.memberId());
    // ê¸°ì¡´ì— í™•ì •ëœ ì˜ˆì•½ì´ ìˆëŠ”ì§€ í™•ì¸
    reservationService.checkConfirmedReservationsExistOrThrow(user.getTrainerId(), criteria.reservationDates());
    // ëŒ€ê¸°ì¤‘ì¸ ì˜ˆì•½ì´ ìˆìœ¼ë©´ ê±°ì ˆ
    List<Reservation> refusedReservations = reservationService.refuseWaitingReservations(criteria.reservationDates());
    // ê±°ì ˆì„ í–ˆë‹¤ë©´ -> ë©¤ë²„ì—ê²Œ ì˜ˆì•½ì´ ê±°ì ˆë˜ì—ˆë‹¤ëŠ” ì•Œë¦¼ ì „ì†¡
    refuseReservations(refusedReservations);
    // ê³ ì • ì˜ˆì•½ ì§„í–‰
    List<Reservation> reservationDomains = criteria.toDomain(memberService.getSessionInfo(user.getTrainerId(),
            criteria.memberId()), user);
    SessionInfo sessionInfo = memberService.getSessionInfo(user.getTrainerId(), criteria.memberId());
    // ì„¸ì…˜ ì°¨ê°
    memberService.deductSession(user.getTrainerId(), criteria.memberId(), sessionInfo.getRemainingCount());
    List<Reservation> fixedReservations = reservationService.createFixedReservations(reservationDomains,
            sessionInfo.getRemainingCount());
    // íŠ¸ë ˆì´ë„ˆ -> ë©¤ë²„ì—ê²Œ ì˜ˆì•½ ëë‹¤ëŠ” ì•Œë¦¼ ì „ì†¡
    reservationDomains.forEach(r -> {
        PersonalDetail memberDetail = memberService.getMemberDetail(r.getMember().getMemberId());
        Token token = authService.getTokenByPersonalDetailId(memberDetail.getPersonalDetailId());
        notificationService.sendNotification(NotificationCommand.ApproveReservation.of(memberDetail,
                r.getReservationId(), r.getConfirmDate(), r.getTrainer().getTrainerId(), true,
                token.getPushToken()));
    });
    return fixedReservations;
	}
	...
}
```

ì´ ê³¼ì •ì„ ì§€ë‚˜ë©´ì„œ, **ì²˜ìŒ ì„¤ê³„ê°€ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ë¥¼ ë‹¤ì‹œ í•œë²ˆ ê¹¨ë‹«ëŠ” ê³„ê¸°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.**
<br />
<br />

## 9.2. ì•Œë¦¼ ë°œì†¡ ë¡œì§
<br />


### 9-2-1. ê¸°ì¡´ ì•Œë¦¼ ë°œì†¡ ë¡œì§

ì•Œë¦¼ ë°œì†¡ì€ ì„œë¹„ìŠ¤ë¥¼ í•˜ëŠ”ë° ìˆì–´ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤. ì‹¤ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½ì— ëŒ€í•œ ì •ë³´ë‚˜, ì–´ë–¤ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ ì˜ˆì•½ì„ í•˜ê±°ë‚˜ ì–´ë–¤ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ì •í•  ë•Œë§ˆë‹¤ ë§ˆì§€ë§‰ì— ì•Œë¦¼ì„ ì „ì†¡í•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

```java

@Component
@RequiredArgsConstructor
public class MemberFacade {

...

	@Transactional
	public void connectTrainer(Long memberId, String trainerCode) {
	    memberService.checkMemberAlreadyConnected(memberId);
	
	    Trainer trainer = trainerService.getTrainerByCode(trainerCode);
	    Member member = memberService.getMember(memberId);
	
	    ConnectingInfo connectingInfo = memberService.requestConnectTrainer(trainer, member);
	    PersonalDetail trainerDetail = trainerService.getTrainerDetail(trainer.getTrainerId());
	    Token token = authService.getTokenByPersonalDetailId(trainerDetail.getPersonalDetailId());
	
	    notificationService.sendConnectRequestNotification(NotificationCommand.Connect.of(trainerDetail, member.getMemberId(),
	            member.getName(), connectingInfo.getConnectingInfoId(), token.getPushToken()));
	}
...

}
    
...

@Component
@RequiredArgsConstructor
public class ReservationFacade {
  ...
  
	@Transactional
	public Reservation changeRequestReservation(ReservationCriteria.ChangeReqeust criteria) {
	
	    // ì•Œë¦¼ ì „ì†¡ ë©¤ë²„ -> íŠ¸ë ˆì´ë„ˆì—ê²Œ ì˜ˆì•½ ë³€ê²½ ìš”ì²­í–ˆë‹¤ëŠ” ì•Œë¦¼ ë°œì†¡
	    Reservation reservation = reservationService.changeRequestReservation(criteria.toCommand());
	    PersonalDetail trainerDetail = trainerService.getTrainerDetail(reservation.getTrainer().getTrainerId());
	    Token token = authService.getTokenByPersonalDetailId(trainerDetail.getPersonalDetailId());
	
	    notificationService.sendChangeRequestReservationNotification(NotificationCommand.ChangeRequestReservation.of(trainerDetail,
	            reservation.getReservationId(), reservation.getMember().getMemberId(),
	            reservation.getName(), criteria.reservationDate(), criteria.changeRequestDate(),
	            token.getPushToken()));
	
	
	    return reservation;
	}
}

...
    
```

ê·¸ëŸ°ë° ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ë©”ì„œë“œë¥¼ ì‘ì„±í•˜ë©´ì„œ ì•Œë¦¼ ì¢…ë¥˜ ë§ˆë‹¤ ì„œë¹„ìŠ¤ ë¡œì§ì´ í•˜ë‚˜ì”© ëŠ˜ì–´ë‚˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.

```java
@Service
@Transactional
@RequiredArgsConstructor
public class NotificationService {
    private final NotificationRepository notificationRepository;
    private final PushNotificationClient pushNotificationClient;

    public void sendConnectRequestNotification(PersonalDetail trainerDetail, String memberName, Long connectingInfoId) {
        Notification notification = connectRequestNotification(trainerDetail, memberName, connectingInfoId);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }

    public void sendDisconnectNotification(String name, PersonalDetail trainerDetail) {
        Notification notification = disconnectNotification(name, trainerDetail);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }

    public void sendCancelReservationNotification(Long reservationId, PersonalDetail memberDetail, Reason reason) {
        Notification notification = cancelReservationNotification(reservationId, memberDetail, reason);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }

    public void sendCancelRequestReservationNotification(Long reservationId, String name,
                                                         LocalDateTime cancelDate, String cancelReason,
                                                         PersonalDetail trainerDetail,
                                                         Reason reason) {
        Notification notification = cancelRequestReservationNotification(reservationId, name,
                cancelDate, cancelReason, trainerDetail, reason);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }

    public void sendApproveReservationNotification(Long reservationId, PersonalDetail memberDetail) {
        Notification notification = approveReservationNotification(reservationId, memberDetail);
        notificationRepository.save(notification);
    }

    public void sendApproveRequestReservationNotification(Long reservationId, PersonalDetail memberDetail,
                                                          boolean isApprove) {
        Notification notification = approveRequestReservationNotification(reservationId, memberDetail, isApprove);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }

    public void sendChangeRequestReservationNotification(Long reservationId, String name, LocalDateTime reservationDate,
                                                         LocalDateTime changeDate,
                                                         PersonalDetail memberDetail) {
        Notification notification = changeRequestReservationNotification(reservationId, name,
                reservationDate, changeDate, memberDetail);
        notificationRepository.save(notification);
        
        pushNotificationClient.pushNotification(token, title, content);
    }
    
    ...
    
}
```

ì´ëŸ° í˜•íƒœë¼ë©´, ì•Œë¦¼ ì¢…ë¥˜ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡, ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ë©”ì„œë“œë„ ë˜‘ê°™ì´ ëŠ˜ì–´ë‚˜ì•¼ í•˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.

ì¦‰, ê°€ì¥ ë³´í˜¸ë¥¼ ë°›ì•„ì•¼ í•  ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì¸µì—ì„œ **OCPê°€ ì§€ì¼œì§€ì§€ ì•Šê³  ìˆì—ˆë˜ ê²ƒì…ë‹ˆë‹¤.**
<br />
<br />

### 9-2-2. ì „ëµ íŒ¨í„´ ë„ì…

### ì„¤ê³„ ëª©ì 

- ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ ì•Œë¦¼ì„Â **ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°ë¡œ í†µí•©.**
- ê° ì•Œë¦¼ì˜Â **ì…ë ¥ íŒŒë¼ë¯¸í„°ì™€ ìƒì„± ë¡œì§ì„ ë¶„ë¦¬**í•˜ì—¬Â **ìœ ì—°ì„±ê³¼ íƒ€ì… ì•ˆì •ì„± í™•ë³´**.

### ì „ëµ íŒ¨í„´ ì ìš©

- NotificationTypeì— ë”°ë¥¸ ì „ëµì„Â `Map<NotificationType, Function<DTO, Notification>>`Â ìœ¼ë¡œ ë“±ë¡
- ì „ëµ í´ë˜ìŠ¤ 10ê°œ, 20ê°œì”© ë§Œë“œëŠ” ì˜¤ë²„ì—”ì§€ë‹ˆì–´ë§ ë°©ì§€
- ê° ì•Œë¦¼ì€ ì „ìš© DTOë¥¼ ê°€ì§ â†’Â `Map<String, Object>`Â ë˜ëŠ” ë‹¤í˜•ì„± ì—†ì´ë„ ìë™ì™„ì„±/ì»´íŒŒì¼ ì²´í¬ ê°€ëŠ¥
- ì‹¤ìˆ˜ë¡œ ì˜ëª»ëœ íƒ€ì… ì „ë‹¬ ì‹œ ì»´íŒŒì¼ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ ë°œìƒ â†’ ìœ ì§€ë³´ìˆ˜ì„± â†‘

ì—¬ê¸°ì— ë”í•´ ì „ëµ íŒ¨í„´ì„ ì ìš©í•˜ë©´

- ìƒˆë¡œìš´ ì•Œë¦¼ íƒ€ì… ì¶”ê°€ ì‹œ â†’ DTO ì¶”ê°€ + ì „ëµ ë“±ë¡ë§Œ í•˜ë©´ ë¨
- ê¸°ì¡´ ë¡œì§ì€ ìˆ˜ì •í•  í•„ìš” ì—†ìŒ

ì´ê¸° ë•Œë¬¸ì— OCPë¥¼ ì¶©ì¡±ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì ìš© íë¦„ì„ ë³´ë©´

1. ì²˜ìŒì— ì•Œë¦¼ ìš”ì²­ DTO(**ì „ëµ**)ë¥¼ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.

```java
public interface NotificationRequest {
    Notification.NotificationType getType();

    String getPushToken();
}

@Builder
public record Connect(
        PersonalDetail trainerDetail, Long memberId, String memberName,
        Long connectingInfoId, String pushToken
) implements NotificationRequest {
    @Override
    public Notification.NotificationType getType() {
        return Notification.NotificationType.CONNECT;
    }

    @Override
    public String getPushToken() {
        return this.pushToken;
    }

    public static Connect of(PersonalDetail trainerDetail, Long memberId, String memberName,
                             Long connectingInfoId, String pushToken) {
        return Connect.builder()
                .trainerDetail(trainerDetail)
                .memberId(memberId)
                .memberName(memberName)
                .connectingInfoId(connectingInfoId)
                .pushToken(pushToken)
                .build();
    }
}
```

2. ì „ëµì„ ë“±ë¡ ë° ì²˜ë¦¬ë¥¼ í•©ë‹ˆë‹¤.

```java
@Component
public class NotificationStrategyHandler {

  private final Map<Notification.NotificationType, Function<NotificationRequest, Notification>> strategyMap =
          new EnumMap<>(Notification.NotificationType.class);

  @PostConstruct
  public void init() {
      strategyMap.put(Notification.NotificationType.CONNECT, this::handleConnectRequest);
      ...

  }

  @SuppressWarnings("unchecked")
  public <T extends NotificationRequest> Notification handle(T request) {
      Function<T, Notification> strategy = (Function<T, Notification>) strategyMap.get(request.getType());

      if (strategy == null) {
          throw new CustomException(ErrorCode.NOTIFICATION_STRANGE_TYPE);
      }

      return strategy.apply(request);
  }

  private Notification handleConnectRequest(NotificationRequest request) {
      NotificationCommand.Connect dto = (NotificationCommand.Connect) request;
      return Notification.connectRequest(dto.trainerDetail(), dto.memberId(), dto.memberName(),
              dto.connectingInfoId());
  }

  ...
}
```

3. ë“±ë¡í•œ ì „ëµì„ ì´ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class NotificationService {
  private final NotificationStrategyHandler strategyHandler;
  ...

  @Transactional
  public <T extends NotificationRequest> void sendNotification(T request) {
      // 1. DB ì €ì¥
      Notification notification = strategyHandler.handle(request);
      notificationRepository.save(notification);
      // 2. push ì•Œë¦¼ ì „ì†¡ ì´ë²¤íŠ¸ë¡œ ì „ë‹¬
      pushNotificationClient.pushNotification(token, title, content);
  }
}
```

ì •ì„ìœ¼ë¡œëŠ” ì „ëµë§ˆë‹¤ ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ì§€ë§Œ, DTOë¡œ ê·¸ ë¶€ë¶„ì„ ëŒ€ì²´í–ˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ ë¡œì§ì„ ìˆ˜ì •í•˜ê³  ë‚˜ë‹ˆ ì•Œë¦¼ì´ ì¶”ê°€ë˜ë”ë¼ë„, DTOë¥¼ ë§Œë“¤ê³  ì „ëµì„ ì¶”ê°€ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

ì¦‰, NotificationServiceì— ëŒ€í•´ì„œëŠ” **OCPê°€ ì§€ì¼œì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

---
## 10. ë°°í¬ ë§í¬ ë° ìŠ¤í¬ë¦°ìƒ·
<br />

### í”„ë¡ íŠ¸ì—”ë“œ
- https://fit-link-user.vercel.app
- https://fit-link-trainer.vercel.app


---
## 11. í–¥í›„ ê³„íš
<br />

- **í—¬ìŠ¤ ì»¤ë®¤ë‹ˆí‹°**
- **ì±„íŒ…(íŠ¸ë ˆì´ë„ˆ â†” íšŒì›ê°„ì˜ ì†Œí†µ)**
- **ì¸ë°”ë”” ì—°ë™**
- **ê²°ì œ(PT ìˆ˜ì—… ê²°ì œ)**
- **íšŒì›ë³„ PT ì¼ì§€ ê´€ë¦¬**

---
## 12. íŒ€ì› ì •ë³´
<br />

| **Name** | **Position** | **E-Mail** | **GitHub** |
| --- | --- | --- | --- |
| ìµœìµ | FE | [ci980704@gmail.com](mailto:ci980704@gmail.com) | https://github.com/choi-ik |
| ìµœìš©ì¬ | FE | [yongjae.choi20@gmail.com](mailto:yongjae.choi20@gmail.com) | https://github.com/yjc2021 |
| ë§ˆìŠ¹í˜„ | Mobile | [tpdlqj0514@gmail.com](mailto:tpdlqj0514@gmail.com) | https://github.com/MaSeungHyun |
| ë°•ê²½íƒœ | BE | [smileboy0014@gmail.com](mailto:smileboy0014@gmail.com) | https://github.com/smileboy0014 |
| ì´í˜„ê·œ | BE | [azdlgusrb@naver.com](mailto:azdlgusrb@naver.com) | https://github.com/wken5577 |
| ê¶Œì„¸ì˜ | Designer | [tpdud9023@naver.com](https://admin.atlassian.com/o/7cc75f09-da75-490f-a896-40361343b5db/users/712020:27e13b26-4449-4f91-acb0-5717a7a8c9ae) |  |

